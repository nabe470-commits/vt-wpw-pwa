import React, { useEffect, useMemo, useState } from "react";

/**

* VT & WPW & PAC Study App — 完全版+++（心電図検定1級向け）
* * Tabs: Algorithms / Brugada Flow / Localize / WPW 25Map / Gallery / Cases / Annotate / Flashcards / Quiz / Review / Notes / Tests
* * 追加: PAC（期外収縮）のアルゴリズム＆局在診断、PAC波形ギャラリー
* * 強化: Quiz増量（PAC関連を多数追加）
* * Tailwindのみ・単一ファイル
    */

// ---------- Small UI primitives ----------
const TabButton = ({ active, onClick, children }) => (
<button
onClick={onClick}
className={
"px-4 py-2 rounded-full text-sm font-medium transition border " +
(active
? "bg-white text-gray-900 border-gray-300 shadow"
: "bg-transparent text-gray-200 border-gray-700 hover:bg-gray-800")
}

>

```
{children}
```

  </button>
);

const Card = ({ children, className = "" }) => (

  <div className={
    "rounded-2xl border border-gray-800 bg-[#0f1115] p-5 shadow-lg " + className
  }>
    {children}
  </div>
);

const Pill = ({ children }) => ( <span className="inline-block rounded-full bg-gray-800/80 px-2.5 py-1 text-xs text-gray-200 border border-gray-700">
{children} </span>
);

const CheckItem = ({ text }) => (

  <li className="flex items-start gap-2 leading-snug">
    <span className="mt-1 inline-block h-4 w-4 shrink-0 rounded-md border border-gray-700 bg-gray-900/60" />
    <span>{text}</span>
  </li>
);

const Divider = () => (

  <div className="my-6 h-px bg-gradient-to-r from-transparent via-gray-800 to-transparent" />
);

// ---------- Core content (VT / WPW) ----------
const VT_RULES = [
{
title: "まずは病態評価",
bullets: [
"不安定（意識障害・ショック・虚脱・胸痛・重度低血圧）→ 直ちに同期下カルディオバージョン",
"安定しているがWide QRS頻拍 → まずVTとみなして対応（抗不整脈、専門コンサルト）",
],
},
{
title: "VTを強く示唆する所見（どれか1つでも→VT優位）",
bullets: [
"AV解離、キャプチャビート/フュージョンビート",
"極端な電気軸（右上/北西軸）",
"胸部誘導で全誘導同方向（コンコーダンス）",
"aVR導出で最初の40msが鋭いR（またはR>40ms）",
],
},
{
title: "Brugada 4段階アルゴリズム（簡略）",
bullets: [
"① 全胸部誘導でRSが“ない”（R単相 or QSのみ）→ VT",
"② いずれか胸部誘導のRS間隔＞100ms → VT",
"③ AV解離あり → VT",
"④ 形態基準（LBBB様/RBBB様の詳細）でVTを支持",
],
},
{
title: "Vereckei（aVR）アルゴリズム（簡略）",
bullets: [
"aVRで最初のR波あり → VT",
"aVRで初期40msのベクトルが上向き（R優位） → VT",
"aVRのVi/Vt < 1 → VT",
"該当なしならSVT with 伝導障害を検討",
],
},
];

const WPW_RULES = [
{ title: "WPWの基本", bullets: ["洞調律でPR短縮＋デルタ波", "AVRTを生じうる副伝導路の存在"] },
{ title: "頻拍時の型と初期対応", bullets: ["正行性AVRT（狭QRS）→ 迷走神経刺激→アデノシン", "pre-excited AF（不規則Wide）→ AVN遮断薬は避ける", "不安定→同期下CV"] },
{ title: "先行興奮AFの薬物", bullets: ["推奨：プロカインアミド/イブチリド（施設プロトコール）", "避ける：ベラパミル/ジルチ/β遮断/ジギタリス"] },
];

const VT_MNEMONICS = [
{ tag: "赤旗", text: "AV解離 / Capture / Fusion → ほぼVT" },
{ tag: "Brugada", text: "RSなし → RS>100 → AV解離 → 形態" },
{ tag: "aVR", text: "初期R・上向き初期40ms・Vi/Vt<1 → VT" },
];

const WPW_MNEMONICS = [
{ tag: "禁忌", text: "pre-excited AFにAVN遮断薬は避ける" },
{ tag: "初手", text: "安定狭QRS AVRT→ 迷走→アデノシン" },
];

// ---------- PAC（上室期外収縮）追加 ----------
const PAC_RULES = [
{
title: "PACを見抜く（基本）",
bullets: [
"洞より早いタイミングのP'（形が洞Pと異なる）",
"P'のあとにQRSが続けば伝導PAC、続かなければ非伝導PAC（blocked PAC）",
"PAC後のRRは“非代償性”が多い（洞結節リセットでRR<2×基礎RR）",
],
},
{
title: "PAC＋変行伝導（Ashman現象）",
bullets: [
"Long−Shortの直後に右脚ブロック様QRSで出現しやすい",
"P'は存在し、QRSは広いが起源は上室 → VTと誤判しない",
],
},
{
title: "鑑別の落とし穴",
bullets: [
"非伝導PACは“徐脈の中のP波”に見えることがある（房室ブロックと誤診注意）",
"PAC with aberrancy と PVC の鑑別：P'位置、代償性、融合/捕捉の有無",
],
},
];

const PAC_LOCALIZATION = [
{
title: "P'軸でざっくり局在",
bullets: [
"下方軸（II/III/aVF陽性）→ 上位右房/洞結節近傍を示唆",
"上方軸（II/III/aVF陰性）→ 下位右房・冠状静脈洞入口部・左房起源を示唆",
"I/aVLの極性で左房 vs 右房の目安（aVL陰性が左房寄りを示すこと）",
],
},
{
title: "V1のP'極性",
bullets: [
"V1で二相性（+/− あるいは −/+）は右房中隔/左房起源の手掛かり",
"V1で明瞭陽性 → 右房自由壁寄り、明瞭陰性 → 左房後方起源を示唆",
],
},
{
title: "実戦Tips",
bullets: [
"P'は基線の“肩”やT波上に重なることあり → 高倍率で確認",
"PR変動（PACはPR延長や短縮を伴い得る）",
],
},
];

// ---------- Localization data (VT/WPW再掲) ----------
const VT_LOCALIZATION = [
{ title: "LBBB様 vs RBBB様", bullets: ["V1陰性のLBBB様→右室起源（RVOTなど）", "V1陽性のRBBB様→左室起源（LVOT/僧帽弁輪/左脚領域）"] },
{ title: "軸・移行帯", bullets: ["下方軸→流出路","上方軸→心尖/流入路/後壁","移行V2以前→左室寄り、V4以降→右室寄り"] },
{ title: "RVOT vs LVOT", bullets: ["V2 transition ratio>0.6 → LVOT","aVL深いS・aVR高R → LVOT/左冠尖"] },
{ title: "ファシキュラーVT", bullets: ["Verapamil感受性：RBBB様＋上方軸（左後枝）","左前枝：RBBB様＋下方軸"] },
];

const WPW_LOCALIZATION = [
{ title: "デルタ波の極性", bullets: ["V1陰性→右側（RAS/RPS）","V1陽性→左側（LAS/LPS）","下壁陰性→後中隔（PS）","I/aVL陽性＋V1陽性→左側側壁"] },
{ title: "代表組合せ", bullets: ["左側側壁：I・aVL・V6陽性＋V1陽性","右前中隔：V1深い陰性＋I/aVL陰性","後中隔：下壁陰性"] },
];

// ---------- SVG wave gallery ----------
const WaveSVG = ({ type }) => {
const grid = () => ( <pattern id="g" width="20" height="20" patternUnits="userSpaceOnUse">
<path d={`M20 0H0 M0 20V0`} stroke="#1f2937" strokeWidth="1" /> </pattern>
);
const path = {
vt_mono: "M10,80 L60,80 L80,60 L100,110 L120,70 L140,90 L160,80 L180,80 L200,60 L220,110 L240,70 L260,90 L280,80",
delta_pos: "M10,100 L40,100 Q55,95 70,120 T100,100 L140,100",
af_irregular: "M10,80 q10,-10 20,0 t20,0 t20,0 t20,0 M80,80 L100,40 L120,110 L140,50 L160,120 L180,60 L200,110",
capture_fusion: "M10,80 L60,80 L80,60 L100,110 L120,70 L140,90 L160,60 L170,80 L190,60 L210,110 L230,70 L250,90",
pac: "M10,100 L60,100 L80,90 L90,95 L100,100 L140,100", // 早期に小さなP'→通常幅QRS
pac_blocked: "M10,100 L60,100 L80,90 L90,95 L100,100 L140,100 L160,100", // 非伝導PAC（QRSなし）
pac_aberrant: "M10,100 L60,100 L80,90 L90,95 L100,100 L120,100 L140,110 L160,95 L180,100", // PAC後の広いQRS
};
return ( <svg viewBox="0 0 300 160" className="w-full rounded-xl border border-gray-800 bg-gray-900"> <defs>{grid()}</defs> <rect width="100%" height="100%" fill="url(#g)" />
<path d={path[type] || path.vt_mono} stroke="#60a5fa" style={{ strokeWidth: 2, fill: "none" }} /> </svg>
);
};

// ---------- Flashcards ----------
const FLASHCARDS = [
{ q: "Brugadaの最初のステップは？", a: "全胸部誘導でRSがないか確認" },
{ q: "aVRでVT支持の一文は？", a: "初期R/初期40ms上向き/Vi/Vt<1" },
{ q: "pre-excited AFで避ける薬群は？", a: "AVN遮断（ベラパミル/β遮断/ジギタリス/ジルチ）" },
{ q: "PACの非代償性とは？", a: "PACで洞結節がリセット→RRが2×基礎RRより短い" },
];

// ---------- Quiz bank（増量・PAC含む 28問） ----------
const QUIZ = [
// VT核心
{ stem: "aVRで初期R。まず疑う？", options:["SVT with aberrancy","VT","AVNRT","洞調律"], answer:1, explain:"aVR初期R/初期40ms上向きはVT支持。" },
{ stem: "Brugada第1段階：全胸部でRSなし。結論は？", options:["SVT支持","VT支持","所見なし","洞徐脈"], answer:1, explain:"R単相/QSのみ→VT。" },
{ stem: "RS間隔>100ms。結論は？", options:["VT支持","SVT支持","判定不能","心房粗動"], answer:0, explain:"第2段階でVT支持。" },
{ stem: "陽性コンコーダンスの意味は？", options:["VT支持","SVT支持","洞頻拍","WPW"], answer:0, explain:"胸部全R単相→VT支持。" },
{ stem: "不安定なWideQRS頻拍の第一選択は？", options:["アデノシン","同期下CV","ベラパミル","経口β遮断"], answer:1, explain:"循環動態不安定はCV。" },

// VT局在
{ stem: "V1陰性LBBB様＋下方軸。起源は？", options:["RVOT","LVOT","左後枝","心房"], answer:0, explain:"流出路→RVOT。" },
{ stem: "V1陽性RBBB様＋aVL深いS/aVR高R。示唆？", options:["右室流入路","左冠尖/左室流出路","右側側壁","後中隔"], answer:1, explain:"LVOT/左冠尖近傍。" },
{ stem: "V2 transition ratio>0.6 は？", options:["RVOT","LVOT","AVNRT","洞不全"], answer:1, explain:"LVOT示唆。" },
{ stem: "Verapamil感受性VTの形態は？", options:["RBBB様＋上方軸","LBBB様＋下方軸","RBBB様＋下方軸","狭QRS"], answer:0, explain:"左後枝起源。" },

// WPW基礎
{ stem: "pre-excited AFで避ける薬は？", options:["プロカインアミド","イブチリド","ジギタリス","同期下CV"], answer:2, explain:"AVN遮断薬は禁忌。" },
{ stem: "安定正行性AVRTの初手？", options:["同期下CV","迷走神経刺激","ベラパミル静注","アミオダロン"], answer:1, explain:"迷走→アデノシン。" },
{ stem: "V1陰性デルタ＋下壁陰性デルタ。局在は？", options:["左側側壁","右前中隔","後中隔","左前側壁"], answer:2, explain:"右側＋下壁陰性→後中隔寄り。" },
{ stem: "I/aVL/V6陽性デルタ＋V1陽性。局在は？", options:["左側側壁","右側側壁","右前中隔","後中隔"], answer:0, explain:"左側側壁。" },

// PAC基礎
{ stem: "PACの所見として正しいのは？", options:["P'は洞Pと同形","P'は洞より早く形が異なる","常に代償性休止","常にQRSは広い"], answer:1, explain:"PACは早期かつP'形が異なる。" },
{ stem: "非伝導PAC（blocked PAC）の特徴は？", options:["QRSが必ず出る","洞結節はリセットされない","P'後にQRSが出ない","常に代償性休止になる"], answer:2, explain:"P'後にQRSが出ず、RRは非代償性になりやすい。" },
{ stem: "PAC後のRRが2×基礎RRより短い。意味は？", options:["代償性休止","非代償性（洞リセット）","AV解離","房室ブロック"], answer:1, explain:"洞結節リセットで非代償性。" },
{ stem: "Long–Short後に右脚ブロック様の広いQRSで出現。最も考えるのは？", options:["PAC with aberrancy（Ashman）","PVC","VT","WPW"], answer:0, explain:"典型的なAshman現象。" },
{ stem: "非伝導PACは何と誤診されやすい？", options:["房室ブロック","心房粗動","洞徐脈","AVNRT"], answer:0, explain:"P'が見えにくいとAVBに誤る。" },
{ stem: "PACとPVCの鑑別の第一歩は？", options:["QRS幅のみ","P'の有無と位置","T波形の比較","QTc"], answer:1, explain:"P'の有無/位置で起源を推定。" },

// PAC局在
{ stem: "P'が下方軸（II/III/aVF陽性）。示唆は？", options:["上位右房/洞近傍","下位右房/冠静脈洞入口部","左室流出路","右室流入路"], answer:0, explain:"下方軸は上位右房起源を示唆。" },
{ stem: "P'が上方軸（II/III/aVF陰性）。より示唆？", options:["洞結節近傍","下位右房/冠静脈洞入口部/左房","右房自由壁"], answer:1, explain:"下位/左房寄り。" },
{ stem: "V1でP'が二相性（+/−）。示唆は？", options:["右房自由壁","右房中隔/左房起源","左室起源","房室結節"], answer:1, explain:"中隔/左房の手掛かり。" },

// 総合
{ stem: "Wide QRS頻拍で“まずの原則”は？", options:["SVTとして扱う","VTとして扱う","アデノシン静注","経口Ca拮抗薬"], answer:1, explain:"安全第一でVTとして扱う。" },
{ stem: "Capture/Fusionは何を示唆？", options:["SVT","心室起源","房室結節リエントリー","洞頻拍"], answer:1, explain:"心室起源を支持。" },
{ stem: "Vereckei（aVR）法でVi/Vt<1。示唆は？", options:["SVT支持","VT支持","房室ブロック","洞徐脈"], answer:1, explain:"VT支持。" },
{ stem: "PAC with aberrancy とVTの鑑別で有用なのは？", options:["P'位置と先行RR","QTc","U波","電気軸"], answer:0, explain:"P'とLong–Shortの関係が鍵。" },
];

// ---------- Components ----------
const RuleBlock = ({ title, bullets }) => ( <Card> <div className="flex items-start justify-between gap-3"> <h3 className="text-base font-semibold text-white">{title}</h3> </div> <ul className="mt-3 space-y-2 text-sm text-gray-200">
{bullets.map((b, i) => ( <CheckItem key={i} text={b} />
))} </ul> </Card>
);

const MnemonicRow = ({ list }) => (

  <div className="grid gap-2 sm:grid-cols-2">
    {list.map((m, i) => (
      <div key={i} className="flex items-center justify-between rounded-xl border border-gray-800 bg-gray-900/40 px-3 py-2">
        <span className="text-xs text-gray-300"><b className="mr-2 inline-block rounded bg-gray-800 px-2 py-0.5 text-[10px] border border-gray-700">{m.tag}</b>{m.text}</span>
      </div>
    ))}
  </div>
);

const Flashcards = () => {
const [idx, setIdx] = useState(0);
const [show, setShow] = useState(false);
const cards = FLASHCARDS;
const next = () => { setShow(false); setIdx((i) => (i + 1) % cards.length); };
const prev = () => { setShow(false); setIdx((i) => (i - 1 + cards.length) % cards.length); };
const card = cards[idx];
return ( <Card> <div className="flex items-center justify-between"> <h3 className="text-base font-semibold">フラッシュカード</h3> <div className="flex gap-2"> <button onClick={prev} className="rounded-lg border border-gray-700 px-3 py-1 text-sm hover:bg-gray-800">←</button> <button onClick={next} className="rounded-lg border border-gray-700 px-3 py-1 text-sm hover:bg-gray-800">→</button> </div> </div> <Divider /> <div className="grid gap-4 sm:grid-cols-2"> <div className="rounded-xl border border-gray-800 bg-gray-900/50 p-4"> <div className="text-xs text-gray-400">Question</div> <div className="mt-2 text-lg font-semibold text-white">{card.q}</div> </div> <div className="rounded-xl border border-gray-800 bg-gray-900/50 p-4"> <div className="text-xs text-gray-400">Answer</div>
<button onClick={() => setShow((s) => !s)} className="mt-2 rounded-lg border border-gray-700 px-3 py-1 text-sm hover:bg-gray-800">{show ? "隠す" : "表示"}</button>
{show && <div className="mt-3 text-base text-emerald-300">{card.a}</div>} </div> </div> </Card>
);
};

const Quiz = ({ onWrongChange }) => {
const [answers, setAnswers] = useState(Array(QUIZ.length).fill(null));
const [revealed, setRevealed] = useState(false);
const [zoom, setZoom] = useState(null); // 画像ライトボックス将来拡張用

const score = useMemo(() => answers.reduce((acc, a, i) => acc + (a === QUIZ[i].answer ? 1 : 0), 0), [answers]);

useEffect(() => {
if (revealed) {
const wrongIdx = QUIZ.map((q, i) => (answers[i] === q.answer ? null : i)).filter((x) => x !== null);
try { localStorage.setItem("vtwpw_wrong", JSON.stringify(wrongIdx)); } catch {}
onWrongChange?.(wrongIdx);
}
}, [revealed, answers, onWrongChange]);

return ( <Card> <div className="flex items-center justify-between"> <h3 className="text-base font-semibold">クイズ（単一正答・{QUIZ.length}問）</h3> <div className="text-sm text-gray-300">{revealed ? `得点: ${score}/${QUIZ.length}` : <span className="text-gray-500">回答を選択</span>}</div> </div> <Divider /> <div className="space-y-6">
{QUIZ.map((q, qi) => ( <div key={qi} className="rounded-xl border border-gray-800 bg-gray-900/40 p-4"> <div className="text-sm font-semibold text-white">{qi + 1}. {q.stem}</div>
{/* 画像（将来差し込み用）：q.img があれば表示 */}
{q.img && ( <div className="mt-3">
<img src={q.img} alt="12-lead ECG" className="max-h-48 rounded-lg border border-gray-800" onClick={()=>setZoom({src:q.img,caption:q.imgCaption||"12誘導心電図"})} /> <div className="mt-1 text-xs text-gray-400">{q.imgCaption || "12誘導心電図（参考）"}</div> </div>
)} <div className="mt-3 grid gap-2 sm:grid-cols-2">
{q.options.map((opt, oi) => {
const picked = answers[qi] === oi;
const correct = revealed && oi === q.answer;
const wrong = revealed && picked && oi !== q.answer;
return (
<button
key={oi}
onClick={() => { if (!revealed) setAnswers((prev) => prev.map((v, idx) => (idx === qi ? oi : v))); }}
className={
"flex items-center justify-between rounded-lg border px-3 py-2 text-left text-sm transition " +
(correct
? "border-emerald-500/60 bg-emerald-500/10"
: wrong
? "border-rose-500/60 bg-rose-500/10"
: picked
? "border-blue-500/60 bg-blue-500/10"
: "border-gray-800 bg-gray-900/40 hover:bg-gray-800/40")
}
> <span>{opt}</span>
{correct && <span className="text-emerald-400">◎</span>}
{wrong && <span className="text-rose-400">×</span>} </button>
);
})} </div>
{revealed && ( <div className="mt-2 text-xs text-gray-300">解説：{q.explain}</div>
)} </div>
))} </div> <div className="mt-4 flex flex-wrap justify-end gap-2">
<button onClick={() => { try { localStorage.removeItem("vtwpw_wrong"); } catch {}; setAnswers(Array(QUIZ.length).fill(null)); setRevealed(false); }} className="rounded-lg border border-gray-700 px-3 py-1 text-sm hover:bg-gray-800">リセット</button>
<button onClick={() => setRevealed(true)} className="rounded-lg border border-gray-500 bg-white/5 px-3 py-1 text-sm hover:bg-white/10">採点する</button> </div> </Card>
);
};

const Review = () => {
const [wrong, setWrong] = useState([]);
useEffect(() => { try { const raw = localStorage.getItem("vtwpw_wrong"); if (raw) setWrong(JSON.parse(raw)); } catch {} }, []);
const [answers, setAnswers] = useState([]);
const [revealed, setRevealed] = useState(false);
const items = wrong.map((i) => QUIZ[i]).filter(Boolean);
const score = useMemo(() => answers.reduce((acc, a, i) => acc + (a === items[i]?.answer ? 1 : 0), 0), [answers, items]);

return ( <Card> <div className="flex items-center justify-between"> <h3 className="text-base font-semibold">誤答復習（{items.length}問）</h3>
{revealed && <div className="text-sm text-gray-300">{`得点: ${score}/${items.length}`}</div>} </div> <Divider />
{items.length === 0 ? ( <div className="text-sm text-gray-400">誤答はまだ記録されていません。Quizで採点すると自動記録されます。</div>
) : ( <div className="space-y-6">
{items.map((q, qi) => ( <div key={qi} className="rounded-xl border border-gray-800 bg-gray-900/40 p-4"> <div className="text-sm font-semibold text-white">{qi + 1}. {q.stem}</div> <div className="mt-3 grid gap-2 sm:grid-cols-2">
{q.options.map((opt, oi) => {
const picked = answers[qi] === oi;
const correct = revealed && oi === q.answer;
const wrongpick = revealed && picked && oi !== q.answer;
return (
<button
key={oi}
onClick={() => { if (!revealed) { const arr = [...answers]; arr[qi] = oi; setAnswers(arr); } }}
className={
"flex items-center justify-between rounded-lg border px-3 py-2 text-left text-sm transition " +
(correct
? "border-emerald-500/60 bg-emerald-500/10"
: wrongpick
? "border-rose-500/60 bg-rose-500/10"
: picked
? "border-blue-500/60 bg-blue-500/10"
: "border-gray-800 bg-gray-900/40 hover:bg-gray-800/40")
}
> <span>{opt}</span>
{correct && <span className="text-emerald-400">◎</span>}
{wrongpick && <span className="text-rose-400">×</span>} </button>
);
})} </div>
{revealed && <div className="mt-2 text-xs text-gray-300">解説：{q.explain}</div>} </div>
))} </div>
)} <div className="mt-4 flex justify-end gap-2">
<button onClick={() => { try { localStorage.removeItem("vtwpw_wrong"); } catch {}; setWrong([]); setAnswers([]); setRevealed(false); }} className="rounded-lg border border-gray-700 px-3 py-1 text-sm hover:bg-gray-800">クリア</button>
<button onClick={() => setRevealed(true)} className="rounded-lg border border-gray-500 bg-white/5 px-3 py-1 text-sm hover:bg-white/10">採点する</button> </div> </Card>
);
};

const AlgorithmColumn = ({ title, rules, mnemonics }) => (

  <div className="space-y-4">
    <div className="flex items-center justify-between">
      <h2 className="text-lg font-bold text-white">{title}</h2>
      {mnemonics && (
        <div className="flex gap-2">{mnemonics.slice(0, 3).map((m, i) => (<Pill key={i}>{m.tag}</Pill>))}</div>
      )}
    </div>
    {rules.map((r, i) => (<RuleBlock key={i} title={r.title} bullets={r.bullets} />))}
  </div>
);

const Notes = () => {
const [text, setText] = useState("");
useEffect(() => { try { const saved = localStorage.getItem("vtwpw_notes"); if (saved) setText(saved); } catch {} }, []);
const save = () => { try { localStorage.setItem("vtwpw_notes", text); } catch {} };
return ( <Card> <div className="flex items-center justify-between"> <h3 className="text-base font-semibold">自分用ノート</h3> <button onClick={save} className="rounded-lg border border-gray-700 px-3 py-1 text-sm hover:bg-gray-800">保存</button> </div>
<textarea className="mt-3 w-full min-h-48 rounded-xl border border-gray-800 bg-gray-900/50 p-3 text-sm text-gray-100 outline-none" placeholder="講義メモ、症例の気づき、覚え書きなど…" value={text} onChange={(e) => setText(e.target.value)} /> </Card>
);
};

const Localize = () => (

  <div className="grid gap-6 xl:grid-cols-3 lg:grid-cols-2">
    <div className="space-y-4"><AlgorithmColumn title="VT局在：形態・軸・移行帯で推定" rules={VT_LOCALIZATION} mnemonics={VT_MNEMONICS} /></div>
    <div className="space-y-4"><AlgorithmColumn title="WPW局在：デルタ波極性で推定" rules={WPW_LOCALIZATION} mnemonics={WPW_MNEMONICS} /></div>
    <div className="space-y-4"><AlgorithmColumn title="PAC局在：P'軸とV1で推定" rules={PAC_LOCALIZATION} /></div>
  </div>
);

const Gallery = () => (

  <div className="grid gap-6 md:grid-cols-2 xl:grid-cols-3">
    <Card><h3 className="text-base font-semibold">単形性VT（概念図）</h3><div className="mt-3"><WaveSVG type="vt_mono"/></div><p className="mt-2 text-xs text-gray-300">規則正しいWide QRS。形態固定。誘導ごとの形に注目。</p></Card>
    <Card><h3 className="text-base font-semibold">デルタ波陽性（概念図）</h3><div className="mt-3"><WaveSVG type="delta_pos"/></div><p className="mt-2 text-xs text-gray-300">PR短縮＋緩やかな立ち上がり。極性で経路推定。</p></Card>
    <Card><h3 className="text-base font-semibold">pre-excited AF（概念図）</h3><div className="mt-3"><WaveSVG type="af_irregular"/></div><p className="mt-2 text-xs text-gray-300">不規則・Wide・非常に速い。AVN遮断薬は避ける。</p></Card>
    <Card><h3 className="text-base font-semibold">Capture / Fusion（概念図）</h3><div className="mt-3"><WaveSVG type="capture_fusion"/></div><p className="mt-2 text-xs text-gray-300">心室起源支持の所見。</p></Card>
    <Card><h3 className="text-base font-semibold">PAC（伝導）概念図</h3><div className="mt-3"><WaveSVG type="pac"/></div><p className="mt-2 text-xs text-gray-300">早期P'→通常幅QRS。RRは非代償性が多い。</p></Card>
    <Card><h3 className="text-base font-semibold">非伝導PAC（blocked）概念図</h3><div className="mt-3"><WaveSVG type="pac_blocked"/></div><p className="mt-2 text-xs text-gray-300">P'後にQRSなし。AVB誤診に注意。</p></Card>
    <Card><h3 className="text-base font-semibold">PAC with aberrancy（Ashman）</h3><div className="mt-3"><WaveSVG type="pac_aberrant"/></div><p className="mt-2 text-xs text-gray-300">Long–Short後に右脚ブロック様で出現。</p></Card>
  </div>
);

// ---------- Brugada flowchart (図解) ----------
const BrugadaFlow = () => (

  <div className="space-y-4">
    <Card>
      <h2 className="text-lg font-bold text-white">Brugada 4段階アルゴリズム（図解）</h2>
      <Divider />
      <div className="grid gap-4 lg:grid-cols-2">
        <div className="space-y-2 text-sm text-gray-200">
          <p>Wide QRS頻拍の鑑別を段階的に：</p>
          <ol className="list-decimal space-y-1 pl-5">
            <li>全胸部で <b>RSが無い</b> → VT</li>
            <li>いずれか胸部で <b>RS間隔 ＞ 100ms</b> → VT</li>
            <li><b>AV解離</b> あり → VT</li>
            <li>形態基準（LBBB様/RBBB様）でVT支持</li>
          </ol>
          <p className="text-xs text-gray-400">※ どこかで“はい”ならVT優先。全て“いいえ”ならSVT with 伝導障害を検討。</p>
        </div>
        <div>
          <svg viewBox="0 0 520 360" className="w-full rounded-xl border border-gray-800 bg-gray-900">
            <defs>
              <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stopColor="#6ee7b7" />
                <stop offset="100%" stopColor="#93c5fd" />
              </linearGradient>
            </defs>
            <g fontFamily="system-ui" fontSize="12" fill="#e5e7eb" textAnchor="middle">
              <rect x="170" y="10" width="180" height="44" rx="10" stroke="#374151" fill="#111827" />
              <text x="260" y="38">Wide QRS 頻拍</text>
              <rect x="20" y="90" width="200" height="54" rx="10" stroke="#374151" fill="#111827" />
              <text x="120" y="122">① RSなし? → VT</text>
              <rect x="300" y="90" width="200" height="54" rx="10" stroke="#374151" fill="#111827" />
              <text x="400" y="122">② RS&gt;100ms? → VT</text>
              <rect x="20" y="180" width="200" height="54" rx="10" stroke="#374151" fill="#111827" />
              <text x="120" y="212">③ AV解離? → VT</text>
              <rect x="300" y="180" width="200" height="54" rx="10" stroke="#374151" fill="#111827" />
              <text x="400" y="212">④ 形態基準</text>
              <rect x="20" y="270" width="200" height="54" rx="10" stroke="#10b981" fill="#064e3b" />
              <text x="120" y="302">VTとして対応</text>
              <rect x="300" y="270" width="200" height="54" rx="10" stroke="#3b82f6" fill="#0b3b75" />
              <text x="400" y="302">SVT + 変行</text>
            </g>
            <g stroke="url(#g1)" strokeWidth="2" fill="none">
              <path d="M260 54 V 90" />
              <path d="M120 144 V 180" />
              <path d="M400 144 V 180" />
              <path d="M120 234 V 270" />
              <path d="M400 234 V 270" />
            </g>
          </svg>
        </div>
      </div>
    </Card>
  </div>
);

// ---------- WPW 25分割（簡易表） ----------
const WPWMap = () => {
const headers = [" ", "Anterior", "Antero-septal", "Septal", "Postero-septal", "Lateral"];
const rows = [
{ side: "Left Superior", cells: ["I,aVL,V6デルタ陽性", "V1陽性", "-", "下壁±", "側壁強陽性"] },
{ side: "Left Mid", cells: ["I,aVL,V6陽性", "V1陽性", "-", "下壁±", "側壁陽性"] },
{ side: "Left Inferior", cells: ["I陽性 aVL控えめ", "V1陽性", "-", "下壁陽性", "側壁陽性"] },
{ side: "Right Superior", cells: ["I/aVL陰性化", "V1陰性デルタ強", "前中隔陰性", "下壁±", "V6陰性化"] },
{ side: "Right Inferior", cells: ["I陰性化", "V1陰性デルタ", "後中隔寄りで下壁陰性", "下壁陰性強", "V6陰性"] },
];
return ( <div className="space-y-4"> <Card> <h2 className="text-lg font-bold text-white">WPW局在 25分割（暗記用 簡易表）</h2> <p className="mt-1 text-xs text-gray-400">デルタ波極性（I/aVL/V1/V6/下壁）で大枠を素早く推定。厳密な最終局在はEPで決定。</p> <Divider /> <div className="overflow-x-auto"> <table className="w-full text-sm"> <thead> <tr>
{headers.map((h,i)=> (<th key={i} className="border border-gray-800 bg-gray-900/70 px-2 py-2 text-left text-gray-200">{h}</th>))} </tr> </thead> <tbody>
{rows.map((r,ri)=> ( <tr key={ri}> <td className="whitespace-nowrap border border-gray-800 bg-gray-900/40 px-2 py-2 text-gray-300">{r.side}</td>
{r.cells.map((c,ci)=> (<td key={ci} className="border border-gray-800 px-2 py-2 text-gray-100">{c}</td>))} </tr>
))} </tbody> </table> </div> </Card> </div>
);
};

// ---------- 症例ベース模試（既存） ----------
const CASES_BANK = [
{ stem:"58歳男性。規則正しいWide QRS、V1陰性（LBBB様）、下方軸、移行V4以降。", ask:"起源と初期対応は？", options:["RVOT・安定なら薬物/評価","LVOT・即CV","AVNRT・アデノシン","心房細動・除細動"], answer:0, explain:"LBBB様＋下方軸→流出路→RVOT。安定でもVTとして扱う。"},
{ stem:"27歳女性。洞調律でPR短縮＋デルタ波。I/aVL/V6陽性、V1陽性。", ask:"副伝導路局在は？", options:["左側側壁","右前中隔","後中隔","右側側壁"], answer:0, explain:"左側側壁の所見。"},
{ stem:"70歳男性。不規則でWide・高頻拍。", ask:"禁忌薬は？", options:["プロカインアミド","イブチリド","ジギタリス","同期下CV"], answer:2, explain:"pre-excited AF→AVN遮断薬は禁忌。"},
{ stem:"36歳男性。Wide QRS頻拍でaVR初期R。", ask:"最も妥当な診断は？", options:["SVT with aberrancy","心室頻拍","房室結節リエントリー","心房粗動"], answer:1, explain:"aVR初期RはVT支持。"},
];

const Cases = () => {
const [idx, setIdx] = useState(0);
const [sel, setSel] = useState(null);
const [revealed, setRevealed] = useState(false);
const c = CASES_BANK[idx];
const next = () => { setSel(null); setRevealed(false); setIdx((i)=> (i+1)%CASES_BANK.length); };
const prev = () => { setSel(null); setRevealed(false); setIdx((i)=> (i-1+CASES_BANK.length)%CASES_BANK.length); };
return ( <Card> <div className="flex items-center justify-between"> <h3 className="text-base font-semibold">症例ベース模試</h3> <div className="flex gap-2"><button onClick={prev} className="rounded-lg border border-gray-700 px-3 py-1 text-sm hover:bg-gray-800">←</button><button onClick={next} className="rounded-lg border border-gray-700 px-3 py-1 text-sm hover:bg-gray-800">→</button></div> </div> <Divider /> <div className="space-y-3 text-sm"> <div className="text-gray-300">{c.stem}</div> <div className="text-gray-300">設問：{c.ask}</div> <div className="grid gap-2 sm:grid-cols-2">
{c.options.map((o, i)=> (
<button key={i} onClick={()=>!revealed && setSel(i)} className={"rounded-lg border px-3 py-2 text-left "+ (revealed ? (i===c.answer?"border-emerald-500 bg-emerald-500/10":"border-rose-500/60 bg-rose-500/10") : (sel===i?"border-blue-500 bg-blue-500/10":"border-gray-800 bg-gray-900/40 hover:bg-gray-800/40"))}>{o}</button>
))} </div>
{revealed && <div className="text-xs text-gray-300">解説：{c.explain}</div>} <div className="flex justify-end"><button onClick={()=>setRevealed(true)} className="rounded-lg border border-gray-700 px-3 py-1 text-sm hover:bg-gray-800">答えを見る</button></div> </div> </Card>
);
};

// ---------- 実波形アップロード＆注釈（既存） ----------
const Annotate = () => {
const [img, setImg] = useState(null);
const [marks, setMarks] = useState([]);
const [label, setLabel] = useState("P?/Δ?/Capture?/AV解離?/P'?");
const onFile = (e) => { const f = e.target.files?.[0]; if (!f) return; const r = new FileReader(); r.onload = (ev) => setImg(ev.target.result); r.readAsDataURL(f); };
const onClick = (e) => { const rect = e.currentTarget.getBoundingClientRect(); const x = e.clientX - rect.left; const y = e.clientY - rect.top; setMarks((m)=> [...m, {x,y,label}]); };
const clear = () => setMarks([]);
return ( <Card> <h3 className="text-base font-semibold">実波形アップロード＆注釈</h3> <Divider /> <div className="flex flex-col gap-3 sm:flex-row sm:items-center"> <input type="file" accept="image/*" onChange={onFile} className="text-sm" />
<input value={label} onChange={(e)=>setLabel(e.target.value)} className="rounded-lg border border-gray-700 bg-gray-900/50 px-3 py-1 text-sm" /> <button onClick={clear} className="rounded-lg border border-gray-700 px-3 py-1 text-sm hover:bg-gray-800">注釈クリア</button> </div> <div className="mt-4">
{!img ? ( <div className="rounded-xl border border-dashed border-gray-700 p-6 text-center text-sm text-gray-400">ECG画像（PNG/JPG）を選択し、画像上をクリックするとラベルが置けます。</div>
) : ( <div className="relative inline-block"> <img src={img} alt="ecg" className="max-h-[420px] rounded-xl border border-gray-800" onClick={onClick} />
{marks.map((m, i)=> (
<div key={i} className="absolute -translate-x-1/2 -translate-y-1/2" style={{left:m.x, top:m.y}}> <div className="rounded-full border border-emerald-400 bg-emerald-500/20 px-2 py-0.5 text-[10px] text-emerald-200 shadow">{m.label}</div> </div>
))} </div>
)} </div> <p className="mt-2 text-xs text-gray-400">※ ブラウザ内でのみ処理（ローカル）。</p> </Card>
);
};

// ---------- Developer self-tests ----------
const Tests = () => {
const results = [];
try { const tabs = ["Algorithms","Brugada Flow","Localize","WPW 25Map","Gallery","Cases","Annotate","Flashcards","Quiz","Review","Notes"]; results.push({ name: "Tabs定義数", pass: tabs.length === 11 }); } catch (e) { results.push({ name: "Tabs定義数", pass: false }); }
try { results.push({ name: "Quiz問題数>=25", pass: Array.isArray(QUIZ) && QUIZ.length >= 25 }); } catch (e) { results.push({ name: "Quiz問題数>=25", pass: false }); }
try { results.push({ name: "WaveSVG関数", pass: typeof WaveSVG === "function" }); } catch (e) { results.push({ name: "WaveSVG関数", pass: false }); }
return ( <Card> <h3 className="text-base font-semibold">簡易テスト</h3> <Divider /> <ul className="space-y-2 text-sm">
{results.map((r, i) => ( <li key={i} className="flex items-center justify-between rounded-lg border border-gray-800 bg-gray-900/40 px-3 py-2"> <span>{r.name}</span>
<span className={r.pass ? "text-emerald-400" : "text-rose-400"}>{r.pass ? "PASS" : "FAIL"}</span> </li>
))} </ul> </Card>
);
};

// ---------- App ----------
export default function VT_WPW_App() {
const [tab, setTab] = useState("alg");
const [algoSide, setAlgoSide] = useState("VT");
const [wrongIdx, setWrongIdx] = useState([]);
const date = new Date();

useEffect(() => { try { const raw = localStorage.getItem("vtwpw_wrong"); if (raw) setWrongIdx(JSON.parse(raw)); } catch {} }, []);

return ( <div className="min-h-screen bg-[#0b0c10] text-gray-100"> <main className="mx-auto max-w-6xl px-4 py-8"> <header className="mb-6 flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between"> <div> <h1 className="text-2xl font-bold tracking-tight text-white">VT・WPW・PAC 学習アプリ（完全版+++）</h1> <p className="text-sm text-gray-400">1級向け｜VT/WPW/PACのアルゴリズム・局在・波形例・クイズ＆誤答復習</p> </div> <div className="flex items-center gap-2"> <Pill>v2.3</Pill> <Pill>{date.toLocaleDateString()}</Pill>
{wrongIdx?.length > 0 && <Pill>誤答 {wrongIdx.length}</Pill>} </div> </header>

```
    <div className="mb-6 flex flex-wrap gap-2">
      <TabButton active={tab === "alg"} onClick={() => setTab("alg")}>Algorithms</TabButton>
      <TabButton active={tab === "brugada"} onClick={() => setTab("brugada")}>Brugada Flow</TabButton>
      <TabButton active={tab === "loc"} onClick={() => setTab("loc")}>Localize</TabButton>
      <TabButton active={tab === "wpwmap"} onClick={() => setTab("wpwmap")}>WPW 25Map</TabButton>
      <TabButton active={tab === "gallery"} onClick={() => setTab("gallery")}>Gallery</TabButton>
      <TabButton active={tab === "cases"} onClick={() => setTab("cases")}>Cases</TabButton>
      <TabButton active={tab === "annotate"} onClick={() => setTab("annotate")}>Annotate</TabButton>
      <TabButton active={tab === "flash"} onClick={() => setTab("flash")}>Flashcards</TabButton>
      <TabButton active={tab === "quiz"} onClick={() => setTab("quiz")}>Quiz</TabButton>
      <TabButton active={tab === "review"} onClick={() => setTab("review")}>Review</TabButton>
      <TabButton active={tab === "notes"} onClick={() => setTab("notes")}>Notes</TabButton>
      <TabButton active={tab === "tests"} onClick={() => setTab("tests")}>Tests</TabButton>
    </div>

    {tab === "alg" && (
      <div className="grid gap-6 lg:grid-cols-2">
        <div className="space-y-4">
          <Card>
            <div className="flex items-center justify-between">
              <h2 className="text-lg font-bold">アルゴリズム（切替）</h2>
              <div className="flex gap-2">
                {["VT","WPW","PAC"].map((k) => (
                  <button
                    key={k}
                    onClick={() => setAlgoSide(k)}
                    className={
                      "rounded-full border px-3 py-1 text-sm transition " +
                      (algoSide === k ? "border-white bg-white text-gray-900" : "border-gray-700 hover:bg-gray-800")
                    }
                  >
                    {k}
                  </button>
                ))}
              </div>
            </div>
          </Card>

          {algoSide === "VT" && (
            <AlgorithmColumn title="Wide QRS頻拍 → VT優先で判断" rules={VT_RULES} mnemonics={VT_MNEMONICS} />
          )}
          {algoSide === "WPW" && (
            <AlgorithmColumn title="WPW：認識・初期対応・禁忌・根治" rules={WPW_RULES} mnemonics={WPW_MNEMONICS} />
          )}
          {algoSide === "PAC" && (
            <AlgorithmColumn title="PAC：見抜き方・変行伝導・落とし穴" rules={PAC_RULES} />
          )}
        </div>

        <div className="space-y-4">
          <Card>
            <h3 className="text-base font-semibold">スピード暗記モード（片手で流し読み）</h3>
            <Divider />
            <div className="grid gap-3">
              <div>
                <div className="text-xs text-gray-400">一文（VT）</div>
                <div className="mt-1 rounded-xl border border-gray-800 bg-gray-900/50 p-3 text-sm">Wide QRS頻拍は<b>まずVT</b>。<b>AV解離/捕捉・融合</b>、<b>Brugada</b>、<b>aVR</b>で詰める。</div>
              </div>
              <div>
                <div className="text-xs text-gray-400">一文（WPW）</div>
                <div className="mt-1 rounded-xl border border-gray-800 bg-gray-900/50 p-3 text-sm">不規則Wideは<b>pre-excited AF</b>想起。<b>AVN遮断薬は避ける</b>。</div>
              </div>
              <div>
                <div className="text-xs text-gray-400">一文（PAC）</div>
                <div className="mt-1 rounded-xl border border-gray-800 bg-gray-900/50 p-3 text-sm">早期の<b>P'</b>を探す。<b>非代償性休止/変行伝導（Ashman）</b>、<b>非伝導PAC</b>を見逃さない。</div>
              </div>
            </div>
          </Card>
          <Flashcards />
        </div>
      </div>
    )}

    {tab === "brugada" && <BrugadaFlow />}
    {tab === "loc" && <Localize />}
    {tab === "wpwmap" && <WPWMap />}
    {tab === "gallery" && <Gallery />}
    {tab === "cases" && <Cases />}
    {tab === "annotate" && <Annotate />}
    {tab === "flash" && (<div className="space-y-4"><MnemonicRow list={VT_MNEMONICS} /><MnemonicRow list={WPW_MNEMONICS} /><Flashcards /></div>)}
    {tab === "quiz" && (<Quiz onWrongChange={(w)=>setWrongIdx(w)} />)}
    {tab === "review" && (<Review />)}
    {tab === "notes" && (<Notes />)}
    {tab === "tests" && (<Tests />)}

    <footer className="mt-10 text-center text-xs text-gray-500">* 本ツールは学習支援用。実臨床では施設プロトコール・最新ガイドライン・専門医の判断を優先してください。</footer>
  </main>
</div>
```

);
}
